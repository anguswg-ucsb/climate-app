---
title: "Climate predictions"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - { icon: "fa-question-circle", href: "https://water.noaa.gov/about/nwm", align: right }
    theme: cerulean
    orientation: rows
    vertical_layout: fill
---

```{r setup, include = FALSE}
library(shiny)
library(flexdashboard)
library(dataRetrieval)
library(climateR)
library(USAboundaries)
library(USAboundariesData)
library(lubridate)
library(leaflet)
library(sf)
library(raster)
library(dplyr)
library(dygraphs)

source('utils.R')
```

```{r context="server"}
param_lst <- param_meta$terraclim$call
#Initialize Maps 
output$catchMap     <- renderLeaflet({ basemap() })
output$catchMap2     <- renderLeaflet({ second_map() })
# output$countyMap <- renderLeaflet({ pop_map(pop) })
# comid <<- reactiveValues(comid = NULL)
param <- reactive({
  var <- input$variable1
})

click_pt <- eventReactive(input$catchMap_click, {
  click <- input$catchMap_click %>% 
      data.frame() %>% 
      dplyr::select(lat,lng)
    print(click)
    pt <- sf::st_as_sf(click, 
                        coords = c("lng", "lat"), 
                        crs = 4326)
})

raster_data <- eventReactive(input$submitButton, {
  var <-  param()
  bb <- click_to_AOI(click_pt())
  print("click_to_raster")
  click_to_raster(bb, var, dateText1(), dateText2())
})
# point <- reactive({
#     point <-  input$catchMap_click
#     point <-  input$catchMap2_click
# })

```



climateR {data-icon="fa-tint"}
=====================================

Inputs {.sidebar}
-------------------------------------

### Model Filters
```{r}
dateRangeInput("dateTS", label = "Date Input",
          start = "1980-01-01",
          end = "1980-02-01",
               # value = (Sys.Date() -1),
               min = "1980-01-01",
          max = "1980-02-01",
               # max = (Sys.Date() -1),
               format = "yyyy mm dd",
               weekstart = 1)
# dateInput("dateTS", label = "Date Input",
#           value = "2000-01-01",
#                # value = (Sys.Date() -1),
#                min = "1980-01-01",
#           max = "2010-01-01",
#                # max = (Sys.Date() -1),
#                format = "yyyy mm dd",
#                weekstart = 1)
selectInput("variable1",
            label = "Variable", 
            choices = c('prcp', 'rhmax', 'rhmin', 'shum', 'srad', 'wind_dir', 'tmin', 'tmax', 'wind_vel', 'burn_index', 'fmoist_100', 'fmoist_1000', 'energy_release', 'palmer', 'pet_alfalfa', 'pet_grass', 'vpd'))

verbatimTextOutput("dateInputText1")

verbatimTextOutput("dateInputText2")

```

### **Submit**
```{r}
shiny::actionButton("submitButton", label = "Enter", icon("search"))
```

Row
-----------------------------------------------------------------------

### Map1
```{r}
leafletOutput("catchMap")
```

### map 2
```{r}
leafletOutput("catchMap2")
```


```{r context = "server"}
# Clicking on map 1 outputs Value boxes on both pages + catchment polygons + Dat table + info panel
  observeEvent(input$catchMap_click, {
   if(!is.null(input$catchMap_click)) {
    # click <- input$catchMap_click %>% 
    #   data.frame() %>% 
    #   dplyr::select(lat,lng)
    # print(click)
    # pt <- sf::st_as_sf(click, 
    #                     coords = c("lng", "lat"), 
    #                     crs = 4326)
    # 
    # 
    #   
    #   bb <- click_to_AOI(pt)
    #   
    #   # Map 2 fly to bounds
      # bounds <- st_bbox(bb) %>%
      #     st_as_sfc() %>%
      #     st_buffer(0.15) %>%
      #     st_bbox() %>%
      #     as.vector()
      # temp <- climateR::getGridMET(AOI = bb, "tmax", startDate = "2010-01-01")
      # tmax <- temp$tmax[[1]]
      pt <- click_pt()
    bb <- click_to_AOI(pt)
    
    bounds <- st_bbox(bb) %>%
          st_as_sfc() %>%
          st_buffer(0.15) %>%
          st_bbox() %>%
          as.vector()
    leafletProxy("catchMap") %>% 
      clearMarkers() %>%
      clearShapes() %>% 
      addMarkers(data = pt) %>% 
       addPolygons(data = bb,
                   fillColor = 'red',
                   col = "black",
                   weight = 2) %>%
    flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
    
    leafletProxy("catchMap2") %>%
      clearMarkers() %>%
      clearShapes() %>%
      # clearImages() %>% 
      # addRasterImage(x = tmax) %>% 
       addMarkers(data = pt) %>% 
       addPolygons(data = bb,
                   fillColor = 'red',
                   col = "black",
                   weight = 2) %>%
      flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])
   } 

})

# catchMap and catchMap2 are linked while zooming
  observe({ # Observer to respond to zoom / pan of map1 and apply to map2
    coords <- input$catchMap_center
    zoom <- input$catchMap_zoom
    print(coords)
    print(zoom)
    if (!is.null(coords)) {
      leafletProxy("catchMap2") %>%
        setView(lat = coords$lat, lng = coords$lng, zoom = zoom)
    }
})
observeEvent(input$submitButton, {
  if(is.null(input$catchMap_click)){
    NULL
  } else if(!is.null(input$variable1)) {
      var <- param()
      # click <- input$catchMap_click %>%
      #   data.frame() %>%
      #   dplyr::select(lat,lng)
      #
      # print("submit button")
      # pt <- sf::st_as_sf(click,
      #                     coords = c("lng", "lat"),
      #                     crs = 4326)
      pt <- click_pt()
      bb <- click_to_AOI(pt)

      # Map 2 fly to bounds
      bounds <- st_bbox(bb) %>%
          st_as_sfc() %>%
          st_buffer(0.15) %>%
          st_bbox() %>%
          as.vector()

      # rast <- climateR::getGridMET(AOI = bb, var, startDate = dateText())
      print("raster1")
      print(var)

        # r <- rast[[var]][[1]]
      # r <- click_to_raster(bb, var, dateText1(), dateText2())
      leafletProxy("catchMap2") %>%
          clearMarkers() %>%
          clearShapes() %>%
          clearImages() %>%
          # addRasterImage(x = r) %>%
        flyToBounds(bounds[1], bounds[2], bounds[3], bounds[4])

  }
})

# Testing reactive date inputs
dateText1 <- eventReactive(input$submitButton, {
    format.Date(input$dateTS[1])
  })

output$dateInputText1 <- renderText({
   dateText1()
  })

dateText2 <- eventReactive(input$submitButton, {
    format.Date(input$dateTS[2])
  })

output$dateInputText2 <- renderText({
   dateText2()
  })
```

Row
---------------------------------------
### datatable
```{r}
DT::DTOutput('tidyDatatable')
```

```{r context = "server"}
tidy_data <- eventReactive(input$submitButton, {
  tidy_stack(raster_data(), as_sf = TRUE)
})

output$tidyDatatable <- DT::renderDT({
  df <- tidy_data() %>% 
    st_drop_geometry()
  DT::datatable(tidy_data())
})
```

### prediction raster 
```{r}
plotOutput("pointRasterPlot")
```


```{r context = "server"}
pointRaster <- eventReactive(input$submitButton,{
  # predictRaster(tidy_data())
  r <- raster_data()
  empty_raster <- raster::projectExtent(object = r$tmax[[1]],
                                        crs = r$tmax@crs) %>%
    raster::setValues(empty_raster, value = 0)

  # Convert points to sp
  agg <- as(tidy_data(), "Spatial")

  # rastorize prediction points into empty raster grid --- currently rasterizes "last" layer in stack
  rasterize(agg, empty_raster, field = "tmax")
})

output$pointRasterPlot <- renderPlot({
  pred <- pointRaster()
  plot(pred)
})
```

















